#syntax=docker/dockerfile:1.2
#generated by micromamba_core

FROM frolvlad/alpine-glibc
LABEL maintainer="Andreas Trawoeger <atrawog@dorgeln.org>"

USER root
WORKDIR /root
COPY alpine.pkg alpine.pkg
RUN --mount=type=cache,id=apk-cache,target=/etc/apk/cache \
    PKG=`cat alpine.pkg` && echo "Installing ${PKG}" && apk add ${PKG}
RUN echo '%wheel ALL=(ALL) NOPASSWD: ALL' > /etc/sudoers.d/wheel && chmod 0440 /etc/sudoers.d/wheel
RUN sed -i "s/^export PATH=/#export PATH=L/g" /etc/profile

USER root
RUN adduser --disabled-password  -u 1000 -G users jovyan && \
    adduser jovyan wheel

ENV VERSION=0.1.0 \
    PYTHON_VERSION=3.8.8 \
    DOCKER_REPO=dorgeln/orbiter \
    NB_USER=jovyan \
    NB_UID=1000 \ 
    NB_GID=100
ENV LC_ALL=en_US.UTF-8 \
    LANG=en_US.UTF-8 \
    LANGUAGE=en_US.UTF-8 \
    SHELL=/bin/bash \
    JUPYTER_ENABLE_LAB=yes \
    USER=${NB_USER} \
    HOME=/home/${NB_USER} \
    REPO_DIR=/home/${NB_USER} \
    XDG_CACHE_HOME=/home/${NB_USER}/.cache

ENV ENV_ROOT="/env"
ENV MAMBA_EXE=${ENV_ROOT}/bin/micromamba \
    MAMBA_ROOT_PREFIX=${ENV_ROOT}/mamba
ENV PATH=${MAMBA_ROOT_PREFIX}/bin:${ENV_ROOT}/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

RUN mkdir -p ${ENV_ROOT}  && chown ${NB_USER}.${NB_GID} -R ${ENV_ROOT} 

USER jovyan
WORKDIR ${ENV_ROOT}
RUN curl -L https://micro.mamba.pm/api/micromamba/linux-64/latest | tar -xj -C /env bin/micromamba
RUN ${MAMBA_EXE} create -p ${MAMBA_ROOT_PREFIX}
